services:
  webapp:
    restart: unless-stopped
    container_name: webapp
    # image: ghcr.io/your-username/your-repo:your-tag  # Image from GitHub Container Registry
    image: webapp:latest
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NODE_VERSION: 22-alpine
        PNPM_REGISTRY: "https://registry.npmjs.org/"
      target: ${BUILD_STAGE}
    env_file:
      - .env
    volumes:
      - .:/app
      - ./config/data/uploads:/app/config/data/uploads
    networks:
      - net
    depends_on:
      - database
    entrypoint: ["/app/config/scripts/docker-entrypoint.sh"]

  database:
    image: postgres:16
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_PORT: ${DB_PORT}
      POSTGRES_HOST_AUTH_METHOD: md5
    ports:
      - ${POSTGRES_PORT:-5432}:5432
    healthcheck:
      test: "pg_isready --username=${DB_USER} --dbname=${DB_NAME} && psql --username=${DB_USER} --dbname=${DB_NAME} --list"
      interval: 5s
      timeout: 10s
      retries: 10
    volumes:
      - ./config/db/pg_data:/var/lib/postgresql
      - ./config/db/pg_dataset:/docker-entrypoint-initdb.d
    networks:
      - net

  whisper:
    image: onerahmet/openai-whisper-asr-webservice:latest
    container_name: whisper
    restart: unless-stopped
    ports:
      - ${WHISPER_PORT:-9000}:9000
    environment:
      - ASR_MODEL=${WHISPER_MODEL:-base}
      - ASR_ENGINE=${WHISPER_ENGINE:-openai_whisper}
    volumes:
      - ./config/data/uploads:/tmp
    networks:
      - net
    healthcheck:
      test:
        ["CMD", "curl", "-f", "http://localhost:${WHISPER_PORT:-9000}/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # pgadmin:
  #   image: dpage/pgadmin4:latest
  #   container_name: pgadmin
  #   environment:
  #     PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
  #     PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
  #   ports:
  #     - '${PGADMIN_PORT:-5050}:80'
  #   depends_on:
  #     - database
  #   networks:
  #     - net

volumes:
  db:

networks:
  net:
